<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./assets/logo/taekwondo-sbeitla.png" type="image/png" sizes="50x50">
    <title>Training Materials - Taekwondo Sbeitla</title>
    <link rel="stylesheet" href="./style.css">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg"><defs><symbol id="icon-dashboard" viewBox="0 0 24 24"><path d="M3 13H11V3H3M3 21H11V15H3M13 21H21V11H13M13 3V9H21V3" fill="currentColor"/></symbol><symbol id="icon-certificate" viewBox="0 0 24 24"><path d="M4 3C2.9 3 2 3.9 2 5V15C2 16.1 2.9 17 4 17H11V15H4V5H20V15H13V17H20C21.1 17 22 16.1 22 15V5C22 3.9 21.1 3 20 3H4M12 17L9 20V23L12 21L15 23V20L12 17Z" fill="currentColor"/></symbol><symbol id="icon-book" viewBox="0 0 24 24"><path d="M18 2H12V9L9.5 7.5L7 9V2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V4C20 2.9 19.1 2 18 2Z" fill="currentColor"/></symbol><symbol id="icon-message" viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2M20 16H6L4 18V4H20V16M7 9H17V11H7V9M7 6H17V8H7V6M7 12H14V14H7V12Z" fill="currentColor"/></symbol><symbol id="icon-calendar" viewBox="0 0 24 24"><path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4M19 20H5V10H19V20M19 8H5V6H19V8M7 12H12V17H7V12Z" fill="currentColor"/></symbol><symbol id="icon-settings" viewBox="0 0 24 24"><path d="M12 15.5C10.07 15.5 8.5 13.93 8.5 12S10.07 8.5 12 8.5 15.5 10.07 15.5 12 13.93 15.5 12 15.5M19.43 12.97C19.47 12.65 19.5 12.33 19.5 12S19.47 11.35 19.43 11.03L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.5 5.32 14.87 5.07L14.5 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11.03C4.53 11.35 4.5 11.67 4.5 12S4.53 12.65 4.57 12.97L2.46 14.63C2.27 14.78 2.21 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.03 4.95 18.95L7.44 17.94C7.96 18.34 8.5 18.68 9.13 18.93L9.5 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.5 21.58L14.87 18.93C15.5 18.67 16.04 18.34 16.56 17.94L19.05 18.95C19.27 19.03 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.97Z" fill="currentColor"/></symbol><symbol id="icon-logout" viewBox="0 0 24 24"><path d="M16 17V14H9V10H16V7L21 12L16 17M14 2C15.1 2 16 2.9 16 4V6H14V4H5V20H14V18H16V20C16 21.1 15.1 22 14 22H5C3.9 22 3 21.1 3 20V4C3 2.9 3.9 2 5 2H14Z" fill="currentColor"/></symbol></defs></svg>
    <style>
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .material-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .material-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .material-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }

        .material-icon-large {
            font-size: 60px;
        }

        .material-details {
            flex: 1;
        }

        .material-details h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: var(--text-primary);
        }

        .material-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .material-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .type-video {
            background: rgba(255, 87, 34, 0.1);
            color: #ff5722;
        }

        .type-pdf {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .type-guide {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }

        .type-other {
            background: rgba(158, 158, 158, 0.1);
            color: #9e9e9e;
        }

        .material-meta {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .material-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-open {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-open:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-download {
            flex: 1;
            padding: 12px;
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-download:hover {
            background: var(--primary-color);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        /* Material viewer modal */
        .material-viewer-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }

        .material-viewer-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .material-viewer-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 40px;
            animation: zoomIn 0.3s;
        }

        .material-viewer-close {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #666;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
            z-index: 1;
        }

        .material-viewer-close:hover {
            color: #000;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            margin: 20px 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.5); }
            to { transform: scale(1); }
        }
    </style>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo bounce-animation"><img class="logo-img" src="./assets/logo/taekwondo-sbeitla.png" alt="Taekwondo Sbeitla" /></div>
                <h2>Taekwondo Sbeitla</h2>
            </div>
            
            <nav class="sidebar-nav">
                <a href="student-dashboard.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-dashboard"/></svg></span>
                    <span>Dashboard</span>
                </a>
                <a href="student-certificates.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-certificate"/></svg></span>
                    <span>My Certificates</span>
                </a>
                <a href="student-materials.html" class="nav-item active">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-book"/></svg></span>
                    <span>Training Materials</span>
                </a>
                <a href="messages.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-message"/></svg></span>
                    <span>Messages</span>
                    <span class="message-badge" id="sidebarMessageBadge"></span>
                </a>
                <a href="class-schedule.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-calendar"/></svg></span>
                    <span>Schedule</span>
                </a>
                <a href="index.html" class="nav-item logout">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-logout"/></svg></span>
                    <span>Logout</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <header class="page-header">
                <h1>üìö Training Materials</h1>
                <div class="user-info">
                    <span id="studentName">Welcome, Student</span>
                    <span class="online-indicator" title="You are online">üü¢</span>
                </div>
            </header>

            <div class="card">
                <div class="card-header">
                    <h2>All Training Materials (<span id="totalMaterials">0</span>)</h2>
                </div>
                <div class="card-body">
                    <div class="search-filter-bar">
                        <div class="search-box">
                            <input type="text" id="searchMaterials" placeholder="Search materials by title or description...">
                        </div>
                        <select id="filterType" class="filter-select">
                            <option value="all">All Types</option>
                            <option value="video">Videos</option>
                            <option value="pdf">PDFs</option>
                            <option value="guide">Guides</option>
                            <option value="other">Other</option>
                        </select>
                        <select id="sortMaterials" class="filter-select">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="title">Title (A-Z)</option>
                        </select>
                    </div>

                    <div id="materialsGrid" class="materials-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Material Viewer Modal -->
    <div id="materialViewerModal" class="material-viewer-modal">
        <div class="material-viewer-content">
            <span class="material-viewer-close" onclick="closeMaterialViewer()">&times;</span>
            <div id="materialViewerBody">
                <!-- Material content will be loaded here -->
            </div>
        </div>
    </div>
    
    <script type="module" src="./script.js"></script>
    <script type="module" src="./online-status.js"></script>
    <script type="module" src="./messages.js"></script>
    <script>
        // Check if user is student
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || currentUser.role !== 'student') {
            alert('Access denied! This page is for students only.');
            window.location.href = 'index.html';
        }

        let allMaterials = [];
        let filteredMaterials = [];

        const typeIcons = {
            'video': 'üìπ',
            'pdf': 'üìÑ',
            'guide': 'üìñ',
            'other': 'üìé'
        };

        function dataUrlToBlobUrl(dataUrl) {
            const parts = dataUrl.split(',');
            const mimeMatch = parts[0].match(/:(.*?);/);
            const mime = mimeMatch && mimeMatch[1] ? mimeMatch[1] : 'application/octet-stream';
            const bstr = atob(parts[1] || '');
            const len = bstr.length;
            const u8 = new Uint8Array(len);
            for (let i = 0; i < len; i++) u8[i] = bstr.charCodeAt(i);
            const blob = new Blob([u8], { type: mime });
            return URL.createObjectURL(blob);
        }

        // Load student name
        function loadStudentInfo() {
            if (currentUser) {
                document.getElementById('studentName').textContent = `Welcome, ${currentUser.name}`;
            }
        }

        // Load all training materials
        function loadMaterials() {
            const materials = JSON.parse(localStorage.getItem('trainingMaterials') || '[]');
            
            allMaterials = materials;
            filteredMaterials = [...allMaterials];
            
            document.getElementById('totalMaterials').textContent = allMaterials.length;
            
            if (allMaterials.length === 0) {
                displayEmptyState();
            } else {
                displayMaterials(filteredMaterials);
            }
        }

        // Display empty state
        function displayEmptyState() {
            const grid = document.getElementById('materialsGrid');
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-state-icon">üìö</div>
                    <h3>No Training Materials Available</h3>
                    <p>Training materials will appear here once they are uploaded by your instructors.</p>
                </div>
            `;
        }

        // Display materials
        function displayMaterials(materials) {
            const grid = document.getElementById('materialsGrid');
            
            grid.innerHTML = materials.map(material => {
                const typeClass = `type-${material.type || 'other'}`;
                const typeLabel = (material.type || 'other').toUpperCase();
                
                return `
                    <div class="material-card">
                        <div class="material-header">
                            <div class="material-icon-large">${typeIcons[material.type] || 'üìé'}</div>
                            <div class="material-details">
                                <h3>${material.title}</h3>
                                <p>${material.description}</p>
                                <span class="material-type-badge ${typeClass}">${typeLabel}</span>
                            </div>
                        </div>
                        
                        <div class="material-meta">
                            <div class="meta-item">
                                <span class="meta-label">Uploaded On</span>
                                <span class="meta-value">${material.uploadDate}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Type</span>
                                <span class="meta-value">${typeLabel}</span>
                            </div>
                        </div>
                        
                        <div class="material-actions">
                            <button class="btn-open" onclick="openMaterial('${material.id}')">
                                üëÅÔ∏è Open
                            </button>
                            <button class="btn-download" onclick="downloadMaterial('${material.id}')">
                                üì• Download
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open material in modal
        window.openMaterial = function(materialId) {
            const material = allMaterials.find(m => m.id === materialId);
            if (!material) return;

            const modal = document.getElementById('materialViewerModal');
            const body = document.getElementById('materialViewerBody');
            
            let content = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div style="font-size: 60px;">${typeIcons[material.type] || 'üìé'}</div>
                        <div>
                            <h1 style="margin: 0 0 5px 0; color: var(--text-primary);">${material.title}</h1>
                            <p style="margin: 0; color: var(--text-secondary);">${material.description}</p>
                        </div>
                    </div>
            `;

            // Determine best source to render
            const hasDataUrl = typeof material.fileData === 'string' && material.fileData.startsWith('data:');
            const isPdfData = hasDataUrl && material.fileData.indexOf('application/pdf') !== -1;
            const isImageData = hasDataUrl && material.fileData.indexOf('image/') !== -1;
            const isVideoData = hasDataUrl && material.fileData.indexOf('video/') !== -1;

            if (material.type === 'video' && material.videoUrl) {
                content += `
                    <div class="video-container">
                        <iframe src="${material.videoUrl}" frameborder="0" allowfullscreen></iframe>
                    </div>
                `;
            } else if (isVideoData) {
                const videoSrc = dataUrlToBlobUrl(material.fileData);
                content += `
                    <div style="margin: 20px 0;">
                        <video src="${videoSrc}" controls style="width: 100%; max-height: 70vh; border-radius: 8px; background: #000"></video>
                    </div>
                `;
            } else if ((material.type === 'pdf' && material.fileUrl) || isPdfData) {
                const src = isPdfData ? dataUrlToBlobUrl(material.fileData) : material.fileUrl;
                content += `
                    <div style="margin: 20px 0;">
                        <iframe src="${src}" style="width: 100%; height: 600px; border: 1px solid var(--border-color); border-radius: 8px;"></iframe>
                        <div style="text-align:center; margin-top:12px;">
                            <a href="${src}" target="_blank" rel="noopener" class="btn-open" style="display:inline-flex; max-width: 280px;">Open in new tab</a>
                        </div>
                    </div>
                `;
            } else if (isImageData) {
                content += `
                    <div style="margin: 20px 0; display: flex; justify-content: center;">
                        <img src="${material.fileData}" style="max-width: 100%; max-height: 80vh; border-radius: 8px;" />
                    </div>
                `;
            } else if (material.fileUrl) {
                content += `
                    <div style="padding: 20px; text-align: center;">
                        <a href="${material.fileUrl}" target="_blank" class="btn-open" style="max-width: 280px; margin: 0 auto; display: inline-flex;">Open in new tab</a>
                    </div>
                `;
            } else {
                content += `
                    <div style="padding: 40px; text-align: center; background: rgba(102, 126, 234, 0.05); border-radius: 12px; margin: 20px 0;">
                        <div style="font-size: 60px; margin-bottom: 15px;">${typeIcons[material.type] || 'üìé'}</div>
                        <p style="margin: 0; color: var(--text-secondary);">This material can be downloaded for offline viewing.</p>
                    </div>
                `;
            }

            content += `
                    <div style="display: flex; justify-content: space-around; margin: 20px 0; padding: 20px; border-top: 2px solid var(--border-color);">
                        <div>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: var(--text-secondary);">Uploaded On</p>
                            <p style="margin: 0; font-weight: 600;">${material.uploadDate}</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: var(--text-secondary);">Type</p>
                            <p style="margin: 0; font-weight: 600;">${(material.type || 'other').toUpperCase()}</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn-download" onclick="downloadMaterial('${material.id}')" style="max-width: 300px; margin: 0 auto;">
                            üì• Download Material
                        </button>
                    </div>
                </div>
            `;
            
            body.innerHTML = content;
            modal.classList.add('active');
        };

        // Close material viewer
        window.closeMaterialViewer = function() {
            const modal = document.getElementById('materialViewerModal');
            modal.classList.remove('active');
        };

        // Download material
        window.downloadMaterial = function(materialId) {
            const material = allMaterials.find(m => m.id === materialId);
            if (!material) return;

            if (material.fileData) {
                const a = document.createElement('a');
                a.href = material.fileData;
                const safeName = (material.fileName || `${material.title}`).replace(/[^a-z0-9_\-\.]/gi, '_');
                a.download = safeName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                return;
            }

            if (material.fileUrl) {
                const link = document.createElement('a');
                link.href = material.fileUrl;
                link.download = `${material.title.replace(/[^a-z0-9]/gi, '_')}.${material.type === 'pdf' ? 'pdf' : 'file'}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }

            const fallback = `
TAEKWONDO ACADEMY\nTraining Material\n\nTitle: ${material.title}\nType: ${(material.type || 'other').toUpperCase()}\nDescription: ${material.description}\nUploaded: ${material.uploadDate}\n`;
            const blob = new Blob([fallback], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${material.title.replace(/[^a-z0-9]/gi, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        };

        // Search functionality
        document.getElementById('searchMaterials').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            applyFilters();
        });

        // Type filter
        document.getElementById('filterType').addEventListener('change', function(e) {
            applyFilters();
        });

        // Sort functionality
        document.getElementById('sortMaterials').addEventListener('change', function(e) {
            applyFilters();
        });

        // Apply all filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchMaterials').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const sortBy = document.getElementById('sortMaterials').value;

            // Filter by search and type
            filteredMaterials = allMaterials.filter(material => {
                const matchesSearch = material.title.toLowerCase().includes(searchTerm) ||
                                    material.description.toLowerCase().includes(searchTerm);
                const matchesType = typeFilter === 'all' || material.type === typeFilter;
                return matchesSearch && matchesType;
            });

            // Sort
            filteredMaterials.sort((a, b) => {
                if (sortBy === 'newest') {
                    return new Date(b.uploadDate) - new Date(a.uploadDate);
                } else if (sortBy === 'oldest') {
                    return new Date(a.uploadDate) - new Date(b.uploadDate);
                } else if (sortBy === 'title') {
                    return a.title.localeCompare(b.title);
                }
            });

            displayMaterials(filteredMaterials);
        }

        // Close modal when clicking outside
        document.getElementById('materialViewerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMaterialViewer();
            }
        });

        // Load on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentInfo();
            loadMaterials();
        });
    </script>
    <script src="./sponsors.js"></script>
</body>

</html>
