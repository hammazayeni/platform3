<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./assets/logo/taekwondo-sbeitla.png" type="image/png" sizes="50x50">
    <title>My Certificates - Taekwondo Sbeitla</title>
    <link rel="stylesheet" href="./style.css">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg"><defs><symbol id="icon-dashboard" viewBox="0 0 24 24"><path d="M3 13H11V3H3M3 21H11V15H3M13 21H21V11H13M13 3V9H21V3" fill="currentColor"/></symbol><symbol id="icon-certificate" viewBox="0 0 24 24"><path d="M4 3C2.9 3 2 3.9 2 5V15C2 16.1 2.9 17 4 17H11V15H4V5H20V15H13V17H20C21.1 17 22 16.1 22 15V5C22 3.9 21.1 3 20 3H4M12 17L9 20V23L12 21L15 23V20L12 17Z" fill="currentColor"/></symbol><symbol id="icon-book" viewBox="0 0 24 24"><path d="M18 2H12V9L9.5 7.5L7 9V2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V4C20 2.9 19.1 2 18 2Z" fill="currentColor"/></symbol><symbol id="icon-message" viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2M20 16H6L4 18V4H20V16M7 9H17V11H7V9M7 6H17V8H7V6M7 12H14V14H7V12Z" fill="currentColor"/></symbol><symbol id="icon-calendar" viewBox="0 0 24 24"><path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4M19 20H5V10H19V20M19 8H5V6H19V8M7 12H12V17H7V12Z" fill="currentColor"/></symbol><symbol id="icon-settings" viewBox="0 0 24 24"><path d="M12 15.5C10.07 15.5 8.5 13.93 8.5 12S10.07 8.5 12 8.5 15.5 10.07 15.5 12 13.93 15.5 12 15.5M19.43 12.97C19.47 12.65 19.5 12.33 19.5 12S19.47 11.35 19.43 11.03L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.5 5.32 14.87 5.07L14.5 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11.03C4.53 11.35 4.5 11.67 4.5 12S4.53 12.65 4.57 12.97L2.46 14.63C2.27 14.78 2.21 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.03 4.95 18.95L7.44 17.94C7.96 18.34 8.5 18.68 9.13 18.93L9.5 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.5 21.58L14.87 18.93C15.5 18.67 16.04 18.34 16.56 17.94L19.05 18.95C19.27 19.03 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.97Z" fill="currentColor"/></symbol><symbol id="icon-logout" viewBox="0 0 24 24"><path d="M16 17V14H9V10H16V7L21 12L16 17M14 2C15.1 2 16 2.9 16 4V6H14V4H5V20H14V18H16V20C16 21.1 15.1 22 14 22H5C3.9 22 3 21.1 3 20V4C3 2.9 3.9 2 5 2H14Z" fill="currentColor"/></symbol></defs></svg>
    <style>
        .certificates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .certificate-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .certificate-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .certificate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .certificate-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .certificate-icon-large {
            font-size: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .certificate-details {
            flex: 1;
        }

        .certificate-details h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: var(--text-primary);
        }

        .certificate-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .certificate-meta {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .certificate-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-download {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-view {
            flex: 1;
            padding: 12px;
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-view:hover {
            background: var(--primary-color);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        /* Certificate viewer modal */
        .cert-viewer-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }

        .cert-viewer-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .cert-viewer-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 40px;
            animation: zoomIn 0.3s;
        }

        .cert-viewer-close {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #666;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
            z-index: 1;
        }

        .cert-viewer-close:hover {
            color: #000;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.5); }
            to { transform: scale(1); }
        }
    </style>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo bounce-animation"><img class="logo-img" src="./assets/logo/taekwondo-sbeitla.png" alt="Taekwondo Sbeitla" /></div>
                <h2>Taekwondo Sbeitla</h2>
            </div>
            
            <nav class="sidebar-nav">
                <a href="student-dashboard.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-dashboard"/></svg></span>
                    <span>Dashboard</span>
                </a>
                <a href="student-certificates.html" class="nav-item active">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-certificate"/></svg></span>
                    <span>My Certificates</span>
                </a>
                <a href="student-materials.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-book"/></svg></span>
                    <span>Training Materials</span>
                </a>
                <a href="messages.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-message"/></svg></span>
                    <span>Messages</span>
                    <span class="message-badge" id="sidebarMessageBadge"></span>
                </a>
                <a href="class-schedule.html" class="nav-item">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-calendar"/></svg></span>
                    <span>Schedule</span>
                </a>
                <a href="index.html" class="nav-item logout">
                    <span class="icon"><svg width="20" height="20"><use href="#icon-logout"/></svg></span>
                    <span>Logout</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <header class="page-header">
                <h1>üéì My Certificates</h1>
                <div class="user-info">
                    <span id="studentName">Welcome, Student</span>
                    <span class="online-indicator" title="You are online">üü¢</span>
                </div>
            </header>

            <div class="card">
                <div class="card-header">
                    <h2>All Certificates (<span id="totalCertificates">0</span>)</h2>
                </div>
                <div class="card-body">
                    <div class="search-filter-bar">
                        <div class="search-box">
                            <input type="text" id="searchCertificates" placeholder="Search certificates by title...">
                        </div>
                        <select id="sortCertificates" class="filter-select">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="title">Title (A-Z)</option>
                        </select>
                    </div>

                    <div id="certificatesGrid" class="certificates-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Certificate Viewer Modal -->
    <div id="certViewerModal" class="cert-viewer-modal">
        <div class="cert-viewer-content">
            <span class="cert-viewer-close" onclick="closeCertViewer()">&times;</span>
            <div id="certViewerBody">
                <!-- Certificate details will be loaded here -->
            </div>
        </div>
    </div>
    
    <script type="module" src="./script.js"></script>
    <script type="module" src="./online-status.js"></script>
    <script type="module" src="./messages.js"></script>
    <script>
        // Check if user is student
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || currentUser.role !== 'student') {
            alert('Access denied! This page is for students only.');
            window.location.href = 'index.html';
        }

        let allCertificates = [];
        let filteredCertificates = [];

        // Load student name
        function loadStudentInfo() {
            if (currentUser) {
                document.getElementById('studentName').textContent = `Welcome, ${currentUser.name}`;
            }
        }

        // Load all certificates for this student
        function loadCertificates() {
            const certificates = JSON.parse(localStorage.getItem('certificates') || '[]');
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            
            const studentData = students.find(s => 
                s.username === currentUser.username || 
                s.email === currentUser.email ||
                s.id === currentUser.id
            );
            
            let myCerts = [];
            if (studentData) {
                myCerts = certificates.filter(cert => String(cert.studentId) === String(studentData.id));
            } else {
                myCerts = certificates.filter(cert => 
                    (cert.studentName && cert.studentName === currentUser.name) ||
                    (currentUser.id && String(cert.studentId) === String(currentUser.id))
                );
            }
            
            allCertificates = myCerts;
            filteredCertificates = [...allCertificates];
            
            document.getElementById('totalCertificates').textContent = allCertificates.length;
            
            if (allCertificates.length === 0) {
                displayEmptyState();
            } else {
                displayCertificates(filteredCertificates);
            }
        }

        // Display empty state
        function displayEmptyState() {
            const grid = document.getElementById('certificatesGrid');
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-state-icon">üéì</div>
                    <h3>No Certificates Yet</h3>
                    <p>You haven't earned any certificates yet. Keep training hard!</p>
                </div>
            `;
        }

        // Display certificates
        function displayCertificates(certificates) {
            const grid = document.getElementById('certificatesGrid');
            
            grid.innerHTML = certificates.map(cert => `
                <div class="certificate-card">
                    <div class="certificate-header">
                        <div class="certificate-icon-large">üéì</div>
                        <div class="certificate-details">
                            <h3>${cert.title}</h3>
                            <p>${cert.description || 'Certificate of Achievement'}</p>
                        </div>
                    </div>
                    
                    <div class="certificate-meta">
                        <div class="meta-item">
                            <span class="meta-label">Awarded On</span>
                            <span class="meta-value">${cert.uploadDate}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Certificate ID</span>
                            <span class="meta-value">#${String(cert.id).substring(0, 8).toUpperCase()}</span>
                        </div>
                    </div>
                    
                    <div class="certificate-actions">
                        <button class="btn-view" onclick="viewCertificate('${String(cert.id)}')">
                            üëÅÔ∏è View
                        </button>
                        <button class="btn-download" onclick="downloadCertificate('${String(cert.id)}')">
                            üì• Download
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // View certificate in modal
        window.viewCertificate = function(certId) {
            const cert = allCertificates.find(c => String(c.id) === String(certId));
            if (!cert) return;

            const modal = document.getElementById('certViewerModal');
            const body = document.getElementById('certViewerBody');
            
            body.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üéì</div>
                    <h1 style="margin: 0 0 10px 0; color: var(--primary-color);">Certificate of Achievement</h1>
                    <h2 style="margin: 0 0 30px 0; color: var(--text-primary);">${cert.title}</h2>
                    
                    <div style="margin: 30px 0; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 12px;">
                        <p style="font-size: 18px; margin: 0 0 10px 0;">This certificate is proudly presented to</p>
                        <h2 style="margin: 0 0 20px 0; color: var(--primary-color); font-size: 32px;">${currentUser.name}</h2>
                        <p style="margin: 0; color: var(--text-secondary);">${cert.description || 'For outstanding achievement in Taekwondo training'}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-around; margin: 30px 0; padding: 20px; border-top: 2px solid var(--border-color); border-bottom: 2px solid var(--border-color);">
                        <div>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: var(--text-secondary);">Date Awarded</p>
                            <p style="margin: 0; font-weight: 600;">${cert.uploadDate}</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: var(--text-secondary);">Certificate ID</p>
                            <p style="margin: 0; font-weight: 600;">#${String(cert.id).substring(0, 8).toUpperCase()}</p>
                        </div>
                    </div>
                    <div style="margin: 20px 0;">
                        ${cert.fileData && cert.fileData.startsWith('data:application/pdf') ?
                            `<embed src="${cert.fileData}" type="application/pdf" style="width:100%; height:480px; border-radius:12px;" />` :
                            (cert.fileData && cert.fileData.startsWith('data:image') ?
                                `<img src="${cert.fileData}" alt="${cert.title}" style="max-width:100%; border-radius:12px;" />` :
                                `<p style="color: var(--text-secondary);">No preview available</p>`)
                        }
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn-download" onclick="downloadCertificate('${String(cert.id)}')" style="max-width: 300px; margin: 0 auto;">
                            üì• Download Certificate
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        };

        // Close certificate viewer
        window.closeCertViewer = function() {
            const modal = document.getElementById('certViewerModal');
            modal.classList.remove('active');
        };

        // Download certificate
        window.downloadCertificate = function(certId) {
            const cert = allCertificates.find(c => String(c.id) === String(certId));
            if (!cert) return;

            // Prefer stored file data URL
            if (cert.fileData) {
                const link = document.createElement('a');
                link.href = cert.fileData;
                const safeName = (cert.fileName || `${cert.title}_Certificate`).replace(/[^a-z0-9_\-\.]/gi, '_');
                link.download = safeName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert(`üì• Downloading certificate: ${cert.title}`);
            } else if (cert.fileUrl) {
                const link = document.createElement('a');
                link.href = cert.fileUrl;
                link.target = '_blank';
                const safeName = (cert.fileName || `${cert.title}_Certificate`).replace(/[^a-z0-9_\-\.]/gi, '_');
                link.download = safeName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert(`üì• Downloading certificate from URL: ${cert.title}`);
            } else {
                // Generate a simple text file as fallback
                const content = `
TAEKWONDO ACADEMY
Certificate of Achievement

This certificate is proudly presented to:
${currentUser.name}

For: ${cert.title}
${cert.description || 'Outstanding achievement in Taekwondo training'}

Date Awarded: ${cert.uploadDate}
Certificate ID: #${String(cert.id).substring(0, 8).toUpperCase()}

This is an official certificate from Taekwondo Sbeitla.
                `;
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${cert.title.replace(/[^a-z0-9]/gi, '_')}_Certificate.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                alert(`üì• Certificate downloaded as text file. In a production environment, this would be a PDF file.`);
            }
        };

        // Search functionality
        document.getElementById('searchCertificates').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filteredCertificates = allCertificates.filter(cert => 
                cert.title.toLowerCase().includes(searchTerm) ||
                (cert.description && cert.description.toLowerCase().includes(searchTerm))
            );
            displayCertificates(filteredCertificates);
        });

        // Sort functionality
        document.getElementById('sortCertificates').addEventListener('change', function(e) {
            const sortBy = e.target.value;
            
            filteredCertificates.sort((a, b) => {
                if (sortBy === 'newest') {
                    return new Date(b.uploadDate) - new Date(a.uploadDate);
                } else if (sortBy === 'oldest') {
                    return new Date(a.uploadDate) - new Date(b.uploadDate);
                } else if (sortBy === 'title') {
                    return a.title.localeCompare(b.title);
                }
            });
            
            displayCertificates(filteredCertificates);
        });

        // Close modal when clicking outside
        document.getElementById('certViewerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCertViewer();
            }
        });

        // Load on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentInfo();
            loadCertificates();
        });
    </script>
    <script src="./sponsors.js"></script>
</body>

</html>
